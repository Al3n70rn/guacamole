m #! /bin/bash
# Convenience script for users of Mount Sinai's demeter cluster.
#
# Intended to make it convenient to work locally and run on demeter.

# Assumes you have ssh configured so you can type "ssh demeter".
#
# Rsync's the most recently modified guacamole jar and the specified script to demeter, then invokes the script over ssh.
#
# Use in conjunction with an existing script, for example:
#   scripts/guacamole-demeter-over-ssh scripts/guacamole-demeter-yarn threshold -reads ...
#
set -e
set -x

echo "$@" >> ~/.guacamole.invocations.log

export SPARK_MEM=36G
export SPARK_JAVA_OPTS="-Dspark.default.parallelism=1024 -Dspark.shuffle.consolidateFiles=true -Xmx8g -Dspark.speculation=true"
jar=$(ls -tc target/guacamole-?.*.jar | head -n 1)

script=$1
remote_jar=/tmp/$(whoami).$(basename $jar)
remote_script=/tmp/$(whoami).$(basename $script)
rsync --progress $jar demeter:$remote_jar
rsync --progress $script demeter:$remote_script

shift  # drops first commandline argument, our script.
exec time ssh demeter GUACAMOLE_JAR=$remote_jar $remote_script "$@"


